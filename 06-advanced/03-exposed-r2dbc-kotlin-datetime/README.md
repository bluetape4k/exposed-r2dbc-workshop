# 03 Exposed R2DBC Kotlin DateTime example

This module demonstrates how to use the
`exposed-kotlin-datetime` extension, which provides seamless integration with the
`kotlinx.datetime` library. This is the recommended approach for handling date and time in modern, multiplatform Kotlin projects.

## Learning Objectives

- Understand how to map database date/time types to `kotlinx.datetime` objects like `LocalDate`, `LocalDateTime`, and
  `Instant`.
- Use built-in SQL functions for date/time manipulation (e.g., `year()`, `month()`, `day()`).
- Define server-side default values for date/time columns using expressions like `CurrentDateTime`.
- Correctly use date/time literals in `WHERE` clauses for type-safe comparisons.
- Be aware of the differences in date/time handling across various database backends.

## Key Column Types and Functions

The `exposed-kotlin-datetime` module provides a set of column types and functions that parallel the
`exposed-java-time` module, but for the `kotlinx.datetime` library.

### Column Types

- `date(name)`: Maps to `kotlinx.datetime.LocalDate`.
- `time(name)`: Maps to `kotlinx.datetime.LocalTime`.
- `datetime(name)`: Maps to `kotlinx.datetime.LocalDateTime`.
- `timestamp(name)`: Maps to `kotlinx.datetime.Instant`.
- `timestampWithTimeZone(name)`: Maps to `java.time.OffsetDateTime` (as
  `kotlinx.datetime` does not have a native offset-aware type).
- `duration(name)`: Maps to `kotlin.time.Duration`.

### Default Expressions

Use these expressions to set database-generated default values.

- `CurrentDate`: Represents the database's `CURRENT_DATE` function.
- `CurrentDateTime` / `CurrentTimestamp`: Represent the database's `CURRENT_TIMESTAMP` or equivalent function.
- `CurrentTimestampWithTimeZone`: Represents `CURRENT_TIMESTAMP WITH TIME ZONE`.

### Literals for Queries

To ensure correct SQL generation across different database dialects, use these literal functions when making comparisons in
`WHERE` clauses.

- `dateLiteral(LocalDate)`
- `timeLiteral(LocalTime)`
- `dateTimeLiteral(LocalDateTime)`
- `timestampLiteral(Instant)`
- `timestampWithTimeZoneLiteral(OffsetDateTime)`

## Examples Overview

The examples in this module mirror those in the `exposed-java-time` module, demonstrating parallel functionality for
`kotlinx.datetime`.

### `Ex01_KotlinDateTime.kt` - Basic Usage and Functions

This file demonstrates core functionality:

- Using date part extraction functions (`.year()`, `.month()`) in queries.
- Storing and retrieving `kotlinx.datetime` types, including nanosecond precision.
- Working with time zones via `timestampWithTimeZone`.

### `Ex02_Defaults.kt` - Default Values

This file explores setting default values for `kotlinx.datetime` columns.

- `default(value)`: A constant, client-side default.
- `clientDefault { ... }`: A client-side default generated by a lambda.
- `defaultExpression(...)`: A server-side default using database functions like `CurrentDateTime`.

### `Ex03_DateTimeLiteral.kt` - Querying with Literals

This file highlights the correct way to use `kotlinx.datetime` values in
`WHERE` clauses by wrapping them in literal functions (`dateLiteral`,
`dateTimeLiteral`, etc.) to ensure proper SQL formatting.

## Code Snippets

### 1. Defining a Table with `kotlinx.datetime` Columns

```kotlin
import kotlinx.datetime.LocalDateTime
import org.jetbrains.exposed.v1.datetime.datetime
import org.jetbrains.exposed.v1.datetime.CurrentDateTime

object CitiesTime: IntIdTable("CitiesTime") {
  val name: Column<String> = varchar("name", 50)

  // A nullable kotlinx.datetime.LocalDateTime column
  val local_time: Column<LocalDateTime?> = datetime("local_time").nullable()
}

object TableWithDBDefault: IntIdTable() {
  // A non-nullable kotlinx.datetime.LocalDateTime column with a server-side default
  val t1: Column<LocalDateTime> = datetime("t1").defaultExpression(CurrentDateTime)
}
```

### 2. Inserting and Querying `kotlinx.datetime` Values

```kotlin
import kotlinx.datetime.Clock
import kotlinx.datetime.TimeZone
import kotlinx.datetime.toLocalDateTime
import org.jetbrains.exposed.v1.datetime.dateLiteral

// Inserting a value
val now = Clock.System.now().toLocalDateTime(TimeZone.currentSystemDefault())
val cityID = CitiesTime.insertAndGetId {
  it[name] = "Tunisia"
  it[local_time] = now
}

// Querying using a date part function
val insertedMonth = CitiesTime.select(CitiesTime.local_time.month())
  .where { CitiesTime.id eq cityID }
  .single()[CitiesTime.local_time.month()]

// Querying using a literal in a WHERE clause
val result = TableWithDate.selectAll()
  .where { TableWithDate.date less dateLiteral(LocalDate(3000, 1, 1)) }
  .firstOrNull()
```

## Test Execution

```bash
# Run all tests in this module
./gradlew :06-advanced:03-exposed-kotlin-datetime:test

# Run a specific test class
./gradlew :06-advanced:03-exposed-kotlin-datetime:test --tests "exposed.examples.kotlin.datetime.Ex01_KotlinDateTime"
```

## Further Reading

- [Exposed Kotlin DateTime Module](https://debop.notion.site/Exposed-Kotlin-DateTime-1c32744526b0807bb3e8f149ef88f5f5)
